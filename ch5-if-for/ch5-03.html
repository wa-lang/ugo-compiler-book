<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using https://github.com/wa-lang/mnbook -->
        <meta charset="UTF-8">
        <title>if和for到LLIR汇编 - µGo语言实现</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../static/mnbook/css/variables.css">
        <link rel="stylesheet" href="../static/mnbook/css/general.css">
        <link rel="stylesheet" href="../static/mnbook/css/chrome.css">
        <link rel="stylesheet" href="../static/mnbook/css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../static/mnbook/FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../static/mnbook/fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../static/mnbook/highlight.css">
        <link rel="stylesheet" href="../static/mnbook/tomorrow-night.css">
        <link rel="stylesheet" href="../static/mnbook/ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mnbook-theme');
                var sidebar = localStorage.getItem('mnbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mnbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mnbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mnbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mnbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter">
  <li class="chapter-item expanded ">
    <a href="../index.html" >µGo语言实现</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../preface.html" >前言</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch1-basic/readme.html" ><strong aria-hidden="true">1.</strong> 基础</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch1-basic/ch1-01-ugo.html" ><strong aria-hidden="true">1.1.</strong> µGo简介</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1-basic/ch1-02-mini-compiler.html" ><strong aria-hidden="true">1.2.</strong> 最小编译器</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch1-basic/ch1-03-llvm-ir.html" ><strong aria-hidden="true">1.3.</strong> LLVM汇编简介</a>
    </li>
  </ol>
  <li class="chapter-item expanded ">
    <a href="../ch2-expr/readme.html" ><strong aria-hidden="true">2.</strong> 表达式</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch2-expr/ch2-01-add-sub.html" ><strong aria-hidden="true">2.1.</strong> 加减法表达式</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2-expr/ch2-02-mul-div.html" ><strong aria-hidden="true">2.2.</strong> 乘除法表达式</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2-expr/ch2-03-parser.html" ><strong aria-hidden="true">2.3.</strong> 解析表达式语法树</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch2-expr/ch2-04-parser-v2.html" ><strong aria-hidden="true">2.4.</strong> 重构解析器</a>
    </li>
  </ol>
  <li class="chapter-item expanded ">
    <a href="../ch3-hello-ugo/readme.html" ><strong aria-hidden="true">3.</strong> 最小µGo程序</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch3-hello-ugo/ch3-01.html" ><strong aria-hidden="true">3.1.</strong> AST视角的µGo程序</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch3-hello-ugo/ch3-02.html" ><strong aria-hidden="true">3.2.</strong> AST到LLVM汇编</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch3-hello-ugo/ch3-03.html" ><strong aria-hidden="true">3.3.</strong> 完善词法解析器</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch3-hello-ugo/ch3-04.html" ><strong aria-hidden="true">3.4.</strong> 完善语法解析器</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch3-hello-ugo/ch3-05.html" ><strong aria-hidden="true">3.5.</strong> 打印AST语法树</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch3-hello-ugo/ch3-06.html" ><strong aria-hidden="true">3.6.</strong> 命令行界面</a>
    </li>
  </ol>
  <li class="chapter-item expanded ">
    <a href="../ch4-block-and-var/readme.html" ><strong aria-hidden="true">4.</strong> 变量和作用域</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch4-block-and-var/ch4-01.html" ><strong aria-hidden="true">4.1.</strong> 完善token包</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch4-block-and-var/ch4-02.html" ><strong aria-hidden="true">4.2.</strong> 完善AST和解析器</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch4-block-and-var/ch4-03.html" ><strong aria-hidden="true">4.3.</strong> 完善LLIR输出</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch4-block-and-var/ch4-04.html" ><strong aria-hidden="true">4.4.</strong> 输出WASM模块</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch4-block-and-var/ch4-05.html" ><strong aria-hidden="true">4.5.</strong> 简短定义和多赋值</a>
    </li>
  </ol>
  <li class="chapter-item expanded ">
    <a href="../ch5-if-for/readme.html" ><strong aria-hidden="true">5.</strong> if分支和for循环</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch5-if-for/ch5-01.html" ><strong aria-hidden="true">5.1.</strong> 完善token包和lex包</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch5-if-for/ch5-02.html" ><strong aria-hidden="true">5.2.</strong> 完善AST和解析器</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch5-if-for/ch5-03.html" class="active"><strong aria-hidden="true">5.3.</strong> if和for到LLIR汇编</a>
    </li>
  </ol>
  <li class="chapter-item expanded ">
    <a href="../ch6-func/readme.html" ><strong aria-hidden="true">6.</strong> 函数和递归</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch6-func/ch6-01.html" ><strong aria-hidden="true">6.1.</strong> return语句</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch6-func/ch6-02.html" ><strong aria-hidden="true">6.2.</strong> 递归调用µGo函数</a>
    </li>
  </ol>
  <li class="chapter-item expanded ">
    <a href="../ch7-pkgs-files/readme.html" ><strong aria-hidden="true">7.</strong> 多文件和多包支持</a>
  </li>
  <ol class="section">
    <li class="chapter-item expanded ">
      <a href="../ch7-pkgs-files/ch7-01.html" ><strong aria-hidden="true">7.1.</strong> import语句</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch7-pkgs-files/ch7-02.html" ><strong aria-hidden="true">7.2.</strong> 多文件和包依赖</a>
    </li>
    <li class="chapter-item expanded ">
      <a href="../ch7-pkgs-files/ch7-03.html" ><strong aria-hidden="true">7.3.</strong> ugopath配置信息</a>
    </li>
  </ol>
  <li class="chapter-item expanded ">
    <a href="../ch8-string/readme.html" ><strong aria-hidden="true">8.</strong> 字符串</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch9-array/readme.html" ><strong aria-hidden="true">9.</strong> 数组</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch10-map/readme.html" ><strong aria-hidden="true">10.</strong> map</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch11-struct/readme.html" ><strong aria-hidden="true">11.</strong> 结构体</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch12-method/readme.html" ><strong aria-hidden="true">12.</strong> 方法</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch13-closure/readme.html" ><strong aria-hidden="true">13.</strong> 闭包</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch14-interface/readme.html" ><strong aria-hidden="true">14.</strong> 接口</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch15-panic/readme.html" ><strong aria-hidden="true">15.</strong> 异常</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch16-reflect/readme.html" ><strong aria-hidden="true">16.</strong> 反射</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch17-cgo/readme.html" ><strong aria-hidden="true">17.</strong> CGO</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch18-wasm/readme.html" ><strong aria-hidden="true">18.</strong> WASM</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch19-type-system/readme.html" ><strong aria-hidden="true">19.</strong> 类型系统</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch20-bootstrap/readme.html" ><strong aria-hidden="true">20.</strong> 自举</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../ch21-lsp/readme.html" ><strong aria-hidden="true">21.</strong> LSP服务</a>
  </li>
  <li class="chapter-item expanded ">
    <a href="../appendix/readme.html" ><strong aria-hidden="true">22.</strong> 附录</a>
  </li>
</ol>

            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title"><a href="../index.html">µGo语言实现</a></h1>

                    <div class="right-buttons">
                        <a href="https://github.com/wa-lang/ugo-compiler-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/wa-lang/ugo-compiler-book/edit/master/ch5-if-for/ch5-03.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <!-- Page table of contents -->
                    <div class="sidetoc"><nav class="pagetoc"></nav></div>

                    <main>
                        <ul dir="auto"><li><em>凹语言: <a href="https://github.com/wa-lang/wa">https://github.com/wa-lang/wa</a></em></li></ul><hr>

                        <h1>5.3 if和for到LLIR汇编</h1>
<p>本节将新的if和for语法树节点翻译到LLVM-IR，这样uGo就可以达到和图灵机等价的能力，可以实现素数列表的打印程序。</p>
<h2>5.3.1 改进Scope处理</h2>
<p>在之前的后端翻译程序中，enterScope和leaveScope分别对应Scope的进入和退出：</p>
<pre><code class="language-go">func (p *Compiler) enterScope() {
	p.scope = NewScope(p.scope)
}

func (p *Compiler) leaveScope() {
	p.scope = p.scope.Outer
}
</code></pre>
<p>在翻译可能产生新Scope的节点时，在翻译函数开始位置加入以下的代码处理Scope：</p>
<pre><code class="language-go"> func (p *Compiler) compileFunc(w io.Writer, file *ast.File, fn *ast.Func) {
 	p.enterScope()
	defer p.leaveScope()
	...
}
</code></pre>
<p>这样处理需要确保Scope的进入和退出次数完全匹配，对于从多层嵌套的内部Scope直接返回时，处理会显得繁琐。因此我们新增一个restoreScope辅助方法用于恢复前上下文环境的Scope：</p>
<pre><code class="language-go">func (p *Compiler) restoreScope(scope *Scope) {
	p.scope = scope
}
</code></pre>
<p>翻译函数的第一个语句就是通过defer确保函数退出时恢复到之前到Scope状态：</p>
<pre><code class="language-go"> func (p *Compiler) compileFunc(w io.Writer, file *ast.File, fn *ast.Func) {
 	defer p.restoreScope(p.scope)
 	p.enterScope()
	...
}
</code></pre>
<p>对于一些内部简单的Scope可以简化处理。</p>
<h2>5.3.2 重构语句翻译</h2>
<p><code>Compiler.compileStmt</code>方法用于翻译语句，我们将每种语句翻译封装到一个独立的函数中。比如前一章已经支持的赋值语句：</p>
<pre><code class="language-go">func (p *Compiler) compileStmt(w io.Writer, stmt ast.Stmt) {
	switch stmt := stmt.(type) {
	...
	case *ast.AssignStmt:
		p.compileStmt_assign(w, stmt)
	...
	}
}
</code></pre>
<p>赋值语句的翻译代码和之前的处理思路一样：</p>
<pre><code class="language-go">func (p *Compiler) compileStmt_assign(w io.Writer, stmt *ast.AssignStmt) {
	...
	if stmt.Op == token.DEFINE {
		...
	}
	...
}
</code></pre>
<p>采用类似的结构我们就可以轻松增加if和for语句的翻译：</p>
<pre><code class="language-go">func (p *Compiler) compileStmt(w io.Writer, stmt ast.Stmt) {
	switch stmt := stmt.(type) {
	...
	case *ast.IfStmt:
		p.compileStmt_if(w, stmt)

	case *ast.ForStmt:
		p.compileStmt_for(w, stmt)
	...
	}
}
</code></pre>
<p>需要注意的是，compileStmt方法本身只翻译语句，并不直接关联Scope处理。</p>
<h2>5.3.3 新运算符的翻译</h2>
<p>在翻译if语句之前我们还需要先完成比较运算等新运算符的翻译，否则无法处理if的条件部分的表达式。</p>
<p>首先发言取模运算符：</p>
<pre><code class="language-go">func (p *Compiler) compileExpr(w io.Writer, expr ast.Expr) (localName string) {
	switch expr := expr.(type) {
	...
	case *ast.BinaryExpr:
		localName = p.genId()
		switch expr.Op {
		case token.MOD:
			fmt.Fprintf(w, &quot;\t%s = %s i32 %v, %v\n&quot;,
				localName, &quot;srem&quot;, p.compileExpr(w, expr.X), p.compileExpr(w, expr.Y),
			)
			return localName
</code></pre>
<p>比如<code>a%b</code>对于LLVM的<code>srem i32 %a, %b</code>指令。</p>
<p>然后是比较运算符，比较指令可以参考 LLVM 的官方文档 <a href="https://llvm.org/docs/LangRef.html#icmp-instruction">https://llvm.org/docs/LangRef.html#icmp-instruction</a>。比较运算符翻译如下：</p>
<pre><code class="language-go">		// https://llvm.org/docs/LangRef.html#icmp-instruction

		case token.EQL: // ==
			fmt.Fprintf(w, &quot;\t%s = %s i32 %v, %v\n&quot;,
				localName, &quot;icmp eq&quot;, p.compileExpr(w, expr.X), p.compileExpr(w, expr.Y),
			)
			return localName
		case token.NEQ: // !=
			fmt.Fprintf(w, &quot;\t%s = %s i32 %v, %v\n&quot;,
				localName, &quot;icmp ne&quot;, p.compileExpr(w, expr.X), p.compileExpr(w, expr.Y),
			)
			return localName
		case token.LSS: // &lt;
			fmt.Fprintf(w, &quot;\t%s = %s i32 %v, %v\n&quot;,
				localName, &quot;icmp slt&quot;, p.compileExpr(w, expr.X), p.compileExpr(w, expr.Y),
			)
			return localName
		case token.LEQ: // &lt;=
			fmt.Fprintf(w, &quot;\t%s = %s i32 %v, %v\n&quot;,
				localName, &quot;icmp sle&quot;, p.compileExpr(w, expr.X), p.compileExpr(w, expr.Y),
			)
			return localName
		case token.GTR: // &gt;
			fmt.Fprintf(w, &quot;\t%s = %s i32 %v, %v\n&quot;,
				localName, &quot;icmp sgt&quot;, p.compileExpr(w, expr.X), p.compileExpr(w, expr.Y),
			)
			return localName
		case token.GEQ: // &gt;=
			fmt.Fprintf(w, &quot;\t%s = %s i32 %v, %v\n&quot;,
				localName, &quot;icmp sge&quot;, p.compileExpr(w, expr.X), p.compileExpr(w, expr.Y),
			)
			return localName
		}
		...
	}
}
</code></pre>
<p>比如<code>a&gt;=b</code>被翻译为<code>icmp sge i32 %a, %b</code>指令。<code>icmp</code>表示整数的比较，<code>sge</code>表示有符号整数的大于和等于比较。</p>
<h2>5.3.4 翻译if语句</h2>
<p>现在可以翻译if语句了。if语句有一个可选的初始化语句，比如<code>if x := 0; x &gt; 0 {}</code>语句的<code>x</code>对应一个新的Scope，因此需要先处理Scope：</p>
<pre><code class="language-go">func (p *Compiler) compileStmt_if(w io.Writer, stmt *ast.IfStmt) {
	defer p.restoreScope(p.scope)
	p.enterScope()
</code></pre>
<p>在翻译前需要根据if语句的特点构造几个Label位置。我们将<code>if x := 0; x &gt; 0 {}</code>语句重写为以下形式：</p>
<pre><code class="language-go">if_init:
x := 0

if_cond:
cond := x &gt; 0

if_body:
{ ... }
if_end:
</code></pre>
<p>通过4个跳转Label分割if语句的不同部分，对应以下的翻译语句：</p>
<pre><code class="language-go">	ifPos := fmt.Sprintf(&quot;%d&quot;, p.posLine(stmt.If))
	ifInit := p.genLabelId(&quot;if.init.line&quot; + ifPos)
	ifCond := p.genLabelId(&quot;if.cond.line&quot; + ifPos)
	ifBody := p.genLabelId(&quot;if.body.line&quot; + ifPos)
	ifEnd := p.genLabelId(&quot;if.end.line&quot; + ifPos)
</code></pre>
<p>有了Label之后就可以开始翻译if语句了。</p>
<p>根据LLVM-IR的语法要求，每个Label对应的语句块必须有一个终结语句，是直接退出当前函数或者是跳转到其他的语句块。因此为了确保能够终结翻译if语句之前的语句块，我们在当前的指令之上添加一个<code>br</code>跳转指令，跳转的目标是if语句的开头。添加以下翻译代码：</p>
<pre><code class="language-go">	// br if.init
	fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, ifInit)
</code></pre>
<p>然后就可以开始进入if初始化语句的翻译：</p>
<pre><code class="language-go">	// if.init
	{
		fmt.Fprintf(w, &quot;\n%s:\n&quot;, ifInit)
		if stmt.Init != nil {
			p.compileStmt(w, stmt.Init)
		}
	}
</code></pre>
<p>首先定义初始化语句对应的Label，然后如果有初始化语句则递归调用<code>compileStmt</code>翻译其中的赋值语句。需要注意的是<code>compileStmt</code>语句中如果涉及新的命名变量等对象，都是保存在当前的Scope下（但是不是if的body对应的Scope）。</p>
<p>然后是条件部分的翻译（条件部分不需要打开新的Scope空间）：</p>
<pre><code class="language-go">	// br if.cond
	fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, ifCond)

	// if.cond
	{
		fmt.Fprintf(w, &quot;\n%s:\n&quot;, ifCond)
		condValue := p.compileExpr(w, stmt.Cond)
		fmt.Fprintf(w, &quot;\tbr i1 %s , label %%%s, label %%%s\n&quot;, condValue, ifBody, ifEnd)
	}
</code></pre>
<p>条件部分的翻译是通过<code>compileExpr</code>翻译方法完成。当条件中遇到变量名时，会从当前的Scope查询变量。然后通过一个<code>br</code>终结前初始化语句块，跳转的目标是<code>ifCond</code>对应条件判断部分。</p>
<p>处理完条件后，就是if的body部分的翻译：</p>
<pre><code class="language-go">	// if.body
	func() {
		defer p.restoreScope(p.scope)
		p.enterScope()

		fmt.Fprintf(w, &quot;\n%s:\n&quot;, ifBody)
		p.compileStmt(w, stmt.Body)
	}()
</code></pre>
<p>放在闭包函数处理的原因是可以方便通过<code>defer p.restoreScope(p.scope)</code>方式管理嵌套的Scope。然后通过<code>compileStmt</code>翻译函数递归翻译if的语句部分。</p>
<p>最后是终结if的翻译工作：</p>
<pre><code class="language-go">	// br if.end
	fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, ifEnd)

	// end
	fmt.Fprintf(w, &quot;\n%s:\n&quot;, ifEnd)
</code></pre>
<p>也是通过<code>br</code>终结当前块，然后定义新的<code>ifEnd</code>用于后续正常语句翻译需要的Label。</p>
<h2>5.3.5 翻译for语句</h2>
<p>for语句本质上可以通过if和br语句的组合构造而来，for语句的翻译也是同样的思路。先将<code>for x := 0; x &lt; 10; x = x + 1 { body }</code>改成以下形式：</p>
<pre><code class="language-go">for_init:
x := 0;

for_cond:
x &lt; 10

for_post:
x = x + 1

for_body:
body

for_end:
</code></pre>
<p>其中for_init和for_body可能产生新的变量，因此需要处理Scope（通过闭包函数处理）。通过以下代码产生Label：</p>
<pre><code class="language-go">func (p *Compiler) compileStmt_for(w io.Writer, stmt *ast.ForStmt) {
	defer p.restoreScope(p.scope)
	p.enterScope()

	forPos := fmt.Sprintf(&quot;%d&quot;, p.posLine(stmt.For))
	forInit := p.genLabelId(&quot;for.init.line&quot; + forPos)
	forCond := p.genLabelId(&quot;for.cond.line&quot; + forPos)
	forPost := p.genLabelId(&quot;for.post.line&quot; + forPos)
	forBody := p.genLabelId(&quot;for.body.line&quot; + forPos)
	forEnd := p.genLabelId(&quot;for.end.line&quot; + forPos)

	...
}
</code></pre>
<p>参考if语句的翻译思路，先翻译<code>for.init</code>部分：</p>
<pre><code class="language-go">	// br for.init
	fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, forInit)

	// for.init
	fmt.Fprintf(w, &quot;\n%s:\n&quot;, forInit)
	if stmt.Init != nil {
		p.compileStmt(w, stmt.Init)
	}
</code></pre>
<p>对比可以发现翻译的代码几乎和if的init部分完全一样！然后是条件部分的翻译：</p>
<pre><code class="language-go">	// br for.cond
	fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, forCond)

	// for.cond
	fmt.Fprintf(w, &quot;\n%s:\n&quot;, forCond)
	if stmt.Cond != nil {
		condValue := p.compileExpr(w, stmt.Cond)
		fmt.Fprintf(w, &quot;\tbr i1 %s , label %%%s, label %%%s\n&quot;, condValue, forBody, forEnd)
	} else {
		fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, forBody)
	}
</code></pre>
<p>条件部分的翻译依然几乎和if语句的处理完全一样：如果条件满足就跳转到<code>forBody</code>，否则跳转到<code>forEnd</code>。细微的差别是for语句条件是可选的，其终结语句并不一定总是产生，因此对于缺省的真条件在else分支中处理。</p>
<p>然后是for语句的body部分：</p>
<pre><code class="language-go">	// for.body
	func() {
		defer p.restoreScope(p.scope)
		p.enterScope()

		fmt.Fprintf(w, &quot;\n%s:\n&quot;, forBody)
		p.compileStmt(w, stmt.Body)
	}()
</code></pre>
<p>for语句的body和if语句的body的翻译也几乎是一样的。</p>
<p>下面处理for语句的post部分：</p>
<pre><code class="language-go">	// br for.post
	fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, forPost)

	// for.post
	{
		fmt.Fprintf(w, &quot;\n%s:\n&quot;, forPost)
		if stmt.Post != nil {
			p.compileStmt(w, stmt.Post)
		}

		// br for.cond
		fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, forCond)
	}
</code></pre>
<p>for对应的LLVM的块语句的终结语句不是退出循环，而是需要跳转到post循环变量变化的部分。post语句完成之后再跳转到<code>forCond</code>对应到条件判断部分。</p>
<p>最后依然是for语句翻译的终结处理：</p>
<pre><code class="language-go">	// br for.end
	fmt.Fprintf(w, &quot;\tbr label %%%s\n&quot;, forEnd)

	// end
	fmt.Fprintf(w, &quot;\n%s:\n&quot;, forEnd)
</code></pre>
<p>也是通过<code>br</code>终结当前块，然后定义新的<code>forEnd</code>用于后续正常语句翻译需要的Label。</p>
<h2>5.3.6 打印素数列表</h2>
<p>现在已经完成了if和for的翻译工作，我们准备以下的素数列表测试代码：</p>
<pre><code class="language-go">package main

func main() {
	for n := 2; n &lt;= 30; n = n + 1 {
		var isPrime int = 1
		for i := 2; i*i &lt;= n; i = i + 1 {
			if x := n % i; x == 0 {
				isPrime = 0
			}
		}
		if isPrime != 0 {
			println(n)
		}
	}
}
</code></pre>
<p>执行并查看输出结果：</p>
<pre><code class="language-go">$ go run main.go run ./_examples/prime.ugo
2
3
5
7
11
13
17
19
23
</code></pre>
<p>结果正常。</p>


                        

                        
                            <div id="giscus-container"></div>
                        

                        
                            <footer class="page-footer">
                                <span>© 2021-2022 | <a href="https://github.com/chai2010">柴树杉</a> 保留所有权利</span>
                            </footer>
                        
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../ch5-if-for/ch5-02.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                        
                            <!-- ../ch6-func/readme.html -->
                            <a rel="next" href="../ch6-func/readme.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../ch5-if-for/ch5-02.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                
                    <a rel="next" href="../ch6-func/readme.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../static/mnbook/mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../static/mnbook/clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../static/mnbook/highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../static/mnbook/book.js" type="text/javascript" charset="utf-8"></script>
        
        <script type="text/javascript" charset="utf-8">
            var pagePath = "ch5-if-for/ch5-03.md"
        </script>

        <!-- Custom JS scripts -->
        
            <script src="../static/mnbook/giscus.js" type="text/javascript" charset="utf-8"></script>
        

    </body>
</html>
