<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>命令行界面 - µGo语言实现</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="如何从头开发一个迷你Go语言编译器">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../book.html">µGo语言实现</a></li><li class="chapter-item expanded affix "><a href="../preface.html">前言</a></li><li class="chapter-item expanded "><a href="../ch1-basic/index.html"><strong aria-hidden="true">1.</strong> 基础</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch1-basic/ch1-01-ugo.html"><strong aria-hidden="true">1.1.</strong> µGo简介</a></li><li class="chapter-item expanded "><a href="../ch1-basic/ch1-02-mini-compiler.html"><strong aria-hidden="true">1.2.</strong> 最小编译器</a></li><li class="chapter-item expanded "><a href="../ch1-basic/ch1-03-llvm-ir.html"><strong aria-hidden="true">1.3.</strong> LLVM汇编简介</a></li></ol></li><li class="chapter-item expanded "><a href="../ch2-expr/index.html"><strong aria-hidden="true">2.</strong> 表达式</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch2-expr/ch2-01-add-sub.html"><strong aria-hidden="true">2.1.</strong> 加减法表达式</a></li><li class="chapter-item expanded "><a href="../ch2-expr/ch2-02-mul-div.html"><strong aria-hidden="true">2.2.</strong> 乘除法表达式</a></li><li class="chapter-item expanded "><a href="../ch2-expr/ch2-03-parser.html"><strong aria-hidden="true">2.3.</strong> 解析表达式语法树</a></li><li class="chapter-item expanded "><a href="../ch2-expr/ch2-04-parser-v2.html"><strong aria-hidden="true">2.4.</strong> 重构解析器</a></li></ol></li><li class="chapter-item expanded "><a href="../ch3-hello-ugo/index.html"><strong aria-hidden="true">3.</strong> 最小µGo程序</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch3-hello-ugo/ch3-01.html"><strong aria-hidden="true">3.1.</strong> AST视角的µGo程序</a></li><li class="chapter-item expanded "><a href="../ch3-hello-ugo/ch3-02.html"><strong aria-hidden="true">3.2.</strong> AST到LLVM汇编</a></li><li class="chapter-item expanded "><a href="../ch3-hello-ugo/ch3-03.html"><strong aria-hidden="true">3.3.</strong> 完善词法解析器</a></li><li class="chapter-item expanded "><a href="../ch3-hello-ugo/ch3-04.html"><strong aria-hidden="true">3.4.</strong> 完善语法解析器</a></li><li class="chapter-item expanded "><a href="../ch3-hello-ugo/ch3-05.html"><strong aria-hidden="true">3.5.</strong> 打印AST语法树</a></li><li class="chapter-item expanded "><a href="../ch3-hello-ugo/ch3-06.html" class="active"><strong aria-hidden="true">3.6.</strong> 命令行界面</a></li></ol></li><li class="chapter-item expanded "><a href="../ch4-block-and-var/index.html"><strong aria-hidden="true">4.</strong> 变量和作用域</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch4-block-and-var/ch4-01.html"><strong aria-hidden="true">4.1.</strong> 完善token包</a></li><li class="chapter-item expanded "><a href="../ch4-block-and-var/ch4-02.html"><strong aria-hidden="true">4.2.</strong> 完善AST和解析器</a></li><li class="chapter-item expanded "><a href="../ch4-block-and-var/ch4-03.html"><strong aria-hidden="true">4.3.</strong> 完善LLIR输出</a></li><li class="chapter-item expanded "><a href="../ch4-block-and-var/ch4-04.html"><strong aria-hidden="true">4.4.</strong> 输出WASM模块</a></li><li class="chapter-item expanded "><a href="../ch4-block-and-var/ch4-05.html"><strong aria-hidden="true">4.5.</strong> 简短定义和多赋值</a></li></ol></li><li class="chapter-item expanded "><a href="../ch5-if-for/index.html"><strong aria-hidden="true">5.</strong> if分支和for循环</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ch5-if-for/ch5-01.html"><strong aria-hidden="true">5.1.</strong> 完善token包和lex包</a></li><li class="chapter-item expanded "><a href="../ch5-if-for/ch5-02.html"><strong aria-hidden="true">5.2.</strong> 完善AST和解析器</a></li><li class="chapter-item expanded "><a href="../ch5-if-for/ch5-03.html"><strong aria-hidden="true">5.3.</strong> if分支到LLIR汇编</a></li><li class="chapter-item expanded "><a href="../ch5-if-for/ch5-04.html"><strong aria-hidden="true">5.4.</strong> for分支到LLIR汇编</a></li><li class="chapter-item expanded "><a href="../ch5-if-for/ch5-05.html"><strong aria-hidden="true">5.5.</strong> 打印1到100的素数</a></li></ol></li><li class="chapter-item expanded "><a href="../ch6-func/index.html"><strong aria-hidden="true">6.</strong> 函数和递归</a></li><li class="chapter-item expanded "><a href="../ch7-pkgs-files/index.html"><strong aria-hidden="true">7.</strong> 多文件和多包支持</a></li><li class="chapter-item expanded "><a href="../ch8-string/index.html"><strong aria-hidden="true">8.</strong> 字符串</a></li><li class="chapter-item expanded "><a href="../ch9-array/index.html"><strong aria-hidden="true">9.</strong> 数组</a></li><li class="chapter-item expanded "><a href="../ch10-map/index.html"><strong aria-hidden="true">10.</strong> map</a></li><li class="chapter-item expanded "><a href="../ch11-struct/index.html"><strong aria-hidden="true">11.</strong> 结构体</a></li><li class="chapter-item expanded "><a href="../ch12-method/index.html"><strong aria-hidden="true">12.</strong> 方法</a></li><li class="chapter-item expanded "><a href="../ch13-closure/index.html"><strong aria-hidden="true">13.</strong> 闭包</a></li><li class="chapter-item expanded "><a href="../ch14-interface/index.html"><strong aria-hidden="true">14.</strong> 接口</a></li><li class="chapter-item expanded "><a href="../ch15-panic/index.html"><strong aria-hidden="true">15.</strong> 异常</a></li><li class="chapter-item expanded "><a href="../ch16-reflect/index.html"><strong aria-hidden="true">16.</strong> 反射</a></li><li class="chapter-item expanded "><a href="../ch17-cgo/index.html"><strong aria-hidden="true">17.</strong> CGO</a></li><li class="chapter-item expanded "><a href="../ch18-wasm/index.html"><strong aria-hidden="true">18.</strong> WASM</a></li><li class="chapter-item expanded "><a href="../ch19-type-system/index.html"><strong aria-hidden="true">19.</strong> 类型系统</a></li><li class="chapter-item expanded "><a href="../ch20-bootstrap/index.html"><strong aria-hidden="true">20.</strong> 自举</a></li><li class="chapter-item expanded "><a href="../ch21-lsp/index.html"><strong aria-hidden="true">21.</strong> LSP服务</a></li><li class="chapter-item expanded "><a href="../appendix/index.html"><strong aria-hidden="true">22.</strong> 附录</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">µGo语言实现</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/wa-lang/ugo-compiler-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/wa-lang/ugo-compiler-book/edit/master/./ch3-hello-ugo/ch3-06.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="36-命令行界面"><a class="header" href="#36-命令行界面">3.6 命令行界面</a></h1>
<p>本节的目标是将目前功能还比较松散简陋的编译器包装为好用一点的ugo命令，这样更方便测试和遇到便于问题时定位。</p>
<h2 id="361-最小µgo程序再前进一步"><a class="header" href="#361-最小µgo程序再前进一步">3.6.1 最小µGo程序再前进一步</a></h2>
<p>我们先看看本节可以编译执行的稍微复杂一点的程序：</p>
<pre><code class="language-go">package main

func main() {
	println(1)
	println(1000 + 123)
	println(40 + 2)
}
</code></pre>
<p>使用ugo程序直接执行：</p>
<pre><code>$ ugo run ./hello.ugo 
1
1123
42
</code></pre>
<p>看起来还不错。</p>
<h2 id="362-ugo的命令行界面"><a class="header" href="#362-ugo的命令行界面">3.6.2 ugo的命令行界面</a></h2>
<p>和Go社区习惯一致，使用<code>-h</code>查看帮助：</p>
<pre><code>$ ugo -h
NAME:
   ugo - ugo is a tool for managing µGo source code.

USAGE:
   ugo [global options] command [command options] [arguments...]

VERSION:
   0.0.1

COMMANDS:
   run      compile and run µGo program
   build    compile µGo source code
   lex      lex µGo source code and print token list
   ast      parse µGo source code and print ast
   asm      parse µGo source code and print llvm-ir
   help, h  Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --debug, -d     set debug mode (default: false)
   --help, -h      show help (default: false)
   --version, -v   print the version (default: false)
$
</code></pre>
<p>这是基于cli包构建的命令行界面：run用于编译加执行、build构建本地可执行程序、lex输出词法分析结果、ast输出语法树结果、asm输出语法树翻译为LLVM汇编语言的结果。</p>
<h2 id="363-实现ugo命令---main函数"><a class="header" href="#363-实现ugo命令---main函数">3.6.3 实现ugo命令 - main函数</a></h2>
<p>main函数通过cli包定义子命令和相关的参数：</p>
<pre><code class="language-go">package main

import &quot;github.com/urfave/cli/v2&quot;
import &quot;github.com/wa-lang/ugo/build&quot;

func main() {
	app := cli.NewApp()
	app.Name = &quot;ugo&quot;
	app.Usage = &quot;ugo is a tool for managing µGo source code.&quot;
	app.Version = &quot;0.0.1&quot;

	app.Flags = []cli.Flag{
		&amp;cli.StringFlag{Name: &quot;goos&quot;, Usage: &quot;set GOOS&quot;, Value: runtime.GOOS},
		&amp;cli.StringFlag{Name: &quot;goarch&quot;, Usage: &quot;set GOARCH&quot;, Value: runtime.GOARCH},
		&amp;cli.StringFlag{Name: &quot;clang&quot;, Value: &quot;&quot;, Usage: &quot;set clang&quot;},
		&amp;cli.BoolFlag{Name: &quot;debug&quot;, Aliases: []string{&quot;d&quot;}, Usage: &quot;set debug mode&quot;},
	}
</code></pre>
<p>首先是<code>cli.NewApp()</code>定义主命令对象，然后设置名字、提示信息、版本和参数。参数中goos和goarch用于指定目标平台（目前还没有用到），clang则用于支持用户自定义的路径，debug表示调试模式。</p>
<p>然后是定义全部的子命令：</p>
<pre><code class="language-go">	app.Commands = []*cli.Command{
		{
			Name:  &quot;run&quot;,
			Usage: &quot;compile and run µGo program&quot;,
			Action: func(c *cli.Context) error {
				ctx := build.NewContext(build_Options(c))
				output, _ := ctx.Run(c.Args().First(), nil)
				fmt.Print(string(output))
				return nil
			},
		},
		{
			Name:  &quot;build&quot;,
			Usage: &quot;compile µGo source code&quot;,
			Action: func(c *cli.Context) error {
				ctx := build.NewContext(build_Options(c))
				ctx.Build(c.Args().First(), nil, &quot;a.out&quot;)
				return nil
			},
		},
		{
			Name:  &quot;lex&quot;,
			Usage: &quot;lex µGo source code and print token list&quot;,
			Action: func(c *cli.Context) error {
				ctx := build.NewContext(build_Options(c))
				tokens, comments, _ := ctx.Lex(c.Args().First(), nil)
				fmt.Println(tokens)
				fmt.Println(comments)
				return nil
			},
		},
		{
			Name:  &quot;ast&quot;,
			Usage: &quot;parse µGo source code and print ast&quot;,
			Flags: []cli.Flag{
				&amp;cli.BoolFlag{Name: &quot;json&quot;, Usage: &quot;output json format&quot;},
			},
			Action: func(c *cli.Context) error {
				ctx := build.NewContext(build_Options(c))
				f, err := ctx.AST(c.Args().First(), nil)
				if c.Bool(&quot;json&quot;) {
					fmt.Println(f.JSONString())
				} else {
					fmt.Println(f.String())
				}
				return nil
			},
		},
		{
			Name:  &quot;asm&quot;,
			Usage: &quot;parse µGo source code and print llvm-ir&quot;,
			Action: func(c *cli.Context) error {
				ctx := build.NewContext(build_Options(c))
				ll, _ := ctx.ASM(c.Args().First(), nil)
				fmt.Println(ll)
				return nil
			},
		},
	}

	app.Run(os.Args)
}
</code></pre>
<p>对应run、build、lex、ast和asm几个子命令，具体的实现是由build包的Context对象提供的对应方法实现。最后调用<code>app.Run(os.Args)</code>执行命令行。build_Options函数负责从全局参数解析信息，产生执行需要的上下文参数。</p>
<h2 id="364-实现ugo命令---buildcontext对象"><a class="header" href="#364-实现ugo命令---buildcontext对象">3.6.4 实现ugo命令 - build.Context对象</a></h2>
<p>build.Context对象是当前执行命令需要的参数包装：</p>
<pre><code class="language-go">package build

type Option struct {
	Debug  bool
	GOOS   string
	GOARCH string
	Clang  string
}

type Context struct {
	opt  Option
	path string
	src  string
}
</code></pre>
<p>除了目标平台信息，还包含ugo代码的路径。</p>
<p>词法解析方法实现如下：</p>
<pre><code class="language-go">func (p *Context) Lex(filename string, src interface{}) (tokens, comments []token.Token, err error) {
	code, err := p.readSource(filename, src)
	if err != nil {
		return nil, nil, err
	}

	l := lexer.NewLexer(filename, code)
	tokens = l.Tokens()
	comments = l.Comments()
	return
}
</code></pre>
<p>语法树解析方法包装：</p>
<pre><code class="language-go">func (p *Context) AST(filename string, src interface{}) (f *ast.File, err error) {
	code, err := p.readSource(filename, src)
	if err != nil {
		return nil, err
	}

	f, err = parser.ParseFile(filename, code)
	if err != nil {
		return nil, err
	}

	return f, nil
}
</code></pre>
<p>产生LLVM汇编代码的方法包装：</p>
<pre><code class="language-go">func (p *Context) ASM(filename string, src interface{}) (ll string, err error) {
	code, err := p.readSource(filename, src)
	if err != nil {
		return &quot;&quot;, err
	}

	f, err := parser.ParseFile(filename, code)
	if err != nil {
		return &quot;&quot;, err
	}

	ll = new(compiler.Compiler).Compile(f)
	return ll, nil
}
</code></pre>
<p>Build和Run方法定义如下（实现细节就不展开了，具体方式可以参考代码）：</p>
<pre><code class="language-go">func (p *Context) Build(
	filename string, src interface{}, outfile string,
) (output []byte, err error) {
	// ...
}

func (p *Context) Run(filename string, src interface{}) ([]byte, error) {
	// ...
}
</code></pre>
<p>辅助的readSource方法实现如下：</p>
<pre><code class="language-go">func (p *Context) readSource(filename string, src interface{}) (string, error) {
	if src != nil {
		switch s := src.(type) {
		case string:
			return s, nil
		case []byte:
			return string(s), nil
		case *bytes.Buffer:
			if s != nil {
				return s.String(), nil
			}
		case io.Reader:
			d, err := io.ReadAll(s)
			return string(d), err
		}
		return &quot;&quot;, errors.New(&quot;invalid source&quot;)
	}

	d, err := os.ReadFile(filename)
	return string(d), err
}
</code></pre>
<p>这样我们就可以通过指定不同的GOOS和GOARCH实现交叉编译。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ch3-hello-ugo/ch3-05.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../ch4-block-and-var/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ch3-hello-ugo/ch3-05.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../ch4-block-and-var/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
